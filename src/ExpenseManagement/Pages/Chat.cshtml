@page
@model ChatModel
@{
    ViewData["Title"] = "AI Chat Assistant";
}

<h1>ðŸ¤– AI Chat Assistant</h1>

@if (!Model.IsConfigured)
{
    <div class="alert alert-warning">
        <h4 class="alert-heading">AI Chat Not Configured</h4>
        <p>The AI chat feature requires Azure OpenAI to be deployed.</p>
        <hr>
        <p class="mb-0">To enable AI chat, redeploy the infrastructure with the <code>-DeployGenAI</code> switch:</p>
        <pre class="mt-2"><code>.\deploy-infra\deploy.ps1 -ResourceGroup "rg-name" -Location "uksouth" -DeployGenAI</code></pre>
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <div id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f8f9fa;">
                <div class="text-muted text-center">
                    <p>Start a conversation! Try asking:</p>
                    <ul class="text-start" style="max-width: 500px; margin: 0 auto;">
                        <li>"Show me all submitted expenses"</li>
                        <li>"Create an expense for Â£50 for lunch today"</li>
                        <li>"What categories are available?"</li>
                        <li>"Approve expense #1"</li>
                    </ul>
                </div>
            </div>
            <form id="chat-form">
                <div class="input-group">
                    <input type="text" id="user-message" class="form-control" placeholder="Type your message..." required>
                    <button class="btn btn-primary" type="submit" id="send-button">
                        <span id="button-text">Send</span>
                        <span id="button-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
}

@section Scripts {
    @if (Model.IsConfigured)
    {
        <script>
            const chatForm = document.getElementById('chat-form');
            const userMessageInput = document.getElementById('user-message');
            const chatMessages = document.getElementById('chat-messages');
            const sendButton = document.getElementById('send-button');
            const buttonText = document.getElementById('button-text');
            const buttonSpinner = document.getElementById('button-spinner');

            function addMessage(message, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = isUser ? 'mb-3 text-end' : 'mb-3';
                
                const bubble = document.createElement('div');
                bubble.className = isUser 
                    ? 'badge bg-primary text-wrap text-start d-inline-block' 
                    : 'badge bg-light text-dark text-wrap text-start d-inline-block';
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '10px 15px';
                bubble.style.fontSize = '14px';
                bubble.style.whiteSpace = 'pre-wrap';
                
                // Format the message
                let formattedMessage = escapeHtml(message);
                formattedMessage = formatMarkdown(formattedMessage);
                bubble.innerHTML = formattedMessage;
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            function formatMarkdown(text) {
                // Bold text
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Bullet lists
                text = text.replace(/^- (.+)$/gm, 'â€¢ $1');
                // Numbered lists
                text = text.replace(/^(\d+)\. (.+)$/gm, '$1. $2');
                return text;
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const message = userMessageInput.value.trim();
                if (!message) return;
                
                // Add user message
                addMessage(message, true);
                userMessageInput.value = '';
                
                // Disable button and show spinner
                sendButton.disabled = true;
                buttonText.classList.add('d-none');
                buttonSpinner.classList.remove('d-none');
                
                try {
                    const response = await fetch('/Chat?handler=SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.response, false);
                    } else {
                        addMessage('Error: Unable to get response from AI', false);
                    }
                } catch (error) {
                    addMessage('Error: ' + error.message, false);
                } finally {
                    // Re-enable button and hide spinner
                    sendButton.disabled = false;
                    buttonText.classList.remove('d-none');
                    buttonSpinner.classList.add('d-none');
                }
            });
        </script>
    }
}
